name: FPT Education - TicTacToe Game Deployment

on:
  push:
    branches:
      - master
jobs:
  deploy-server:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Server FPTedu-tic-tac-toe
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            echo "ðŸš€ Deploying FPTedu-tic-tac-toe..."
            cd server-tictactoe
            # Sá»­ dá»¥ng PAT trong URL git pull
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S git pull https://${{ secrets.GIT_TOKEN }}@github.com/Tedydev-web/server-tictactoe.git master
            # Sao chÃ©p .env.example thÃ nh .env náº¿u cáº§n
            if [ ! -f .env ] && [ -f .env.example ]; then
              cp .env.example .env
              echo "âœ… Copied .env.example to .env"
            elif [ ! -f .env.example ]; then
              echo "âŒ .env.example does not exist"
              exit 1
            else
              echo "âœ… .env already exists, skipping copy"
            fi
            # Ghi cÃ¡c biáº¿n mÃ´i trÆ°á»ng tá»« GitHub Secrets vÃ o .env
            echo "PORT=3000" >> .env
            echo "ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}" >> .env
            echo "REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}" >> .env
            echo "REFRESH_TOKEN_EXPIRES_IN=1d" >> .env
            echo "${{ secrets.SUDO_PASSWORD }}" | sudo -S npm run build
            pm2 restart website || pm2 start --name website npm -- start
            echo "âœ… Deployment completed"
